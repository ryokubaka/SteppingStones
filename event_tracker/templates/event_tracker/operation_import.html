{% extends "base/base.html" %}
{% load django_bootstrap5 %}

{% block title %}Import Operation{% endblock title %}

{% block body %}
<style nonce="{{ request.csp_nonce }}">
    #import-progress {
        display: none !important;
        visibility: hidden !important;
    }
    #import-progress.show {
        display: block !important;
        visibility: visible !important;
    }
    /* Progress bar width classes - must override Bootstrap's default width with ID selector for higher specificity */
    #progress-bar.progress-bar-0 { width: 0% !important; }
    #progress-bar.progress-bar-5 { width: 5% !important; }
    #progress-bar.progress-bar-10 { width: 10% !important; }
    #progress-bar.progress-bar-15 { width: 15% !important; }
    #progress-bar.progress-bar-20 { width: 20% !important; }
    #progress-bar.progress-bar-25 { width: 25% !important; }
    #progress-bar.progress-bar-30 { width: 30% !important; }
    #progress-bar.progress-bar-35 { width: 35% !important; }
    #progress-bar.progress-bar-40 { width: 40% !important; }
    #progress-bar.progress-bar-45 { width: 45% !important; }
    #progress-bar.progress-bar-50 { width: 50% !important; }
    #progress-bar.progress-bar-55 { width: 55% !important; }
    #progress-bar.progress-bar-60 { width: 60% !important; }
    #progress-bar.progress-bar-65 { width: 65% !important; }
    #progress-bar.progress-bar-70 { width: 70% !important; }
    #progress-bar.progress-bar-75 { width: 75% !important; }
    #progress-bar.progress-bar-80 { width: 80% !important; }
    #progress-bar.progress-bar-85 { width: 85% !important; }
    #progress-bar.progress-bar-90 { width: 90% !important; }
    #progress-bar.progress-bar-95 { width: 95% !important; }
    #progress-bar.progress-bar-100 { width: 100% !important; }
    .import-progress-container { height: 25px; }
</style>
<div class="container mt-4">
    <h2>Import Operation</h2>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <form method="post" enctype="multipart/form-data" novalidate id="import-form">
        {% csrf_token %}
        {% bootstrap_form form %}
        
        <div class="alert alert-info mt-3">
            <strong>Import Options:</strong>
            <ul class="mb-0 mt-2">
                <li><strong>SQLite Database:</strong> Import an existing Stepping Stones operation database (.sqlite3 file)</li>
                <li><strong>JSON File:</strong> Import Cobalt Strike beacon logs from JSON format. This will create a new database from the JSON data.</li>
            </ul>
            <p class="mb-0 mt-2"><em>Note: You can only import one file type at a time.</em></p>
        </div>
        
        <!-- Progress bar (hidden initially) -->
        <div id="import-progress" class="mt-3">
            <div class="alert alert-info">
                <h5>Importing...</h5>
                <div class="progress import-progress-container">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated progress-bar-0" 
                         role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        <span id="progress-text">0%</span>
                    </div>
                </div>
                <p id="progress-message" class="mt-2 mb-0">Starting import...</p>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary" id="submit-btn">Import Operation</button>
        <a href="{% url 'event_tracker:select_operation' %}" class="btn btn-secondary">Cancel</a>
    </form>

    <script nonce="{{ request.csp_nonce }}">
        // Helper function to update progress bar without inline styles (CSP compliant)
        function updateProgressBar(percent) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            if (!progressBar || !progressText) {
                console.error('Progress bar elements not found!');
                return;
            }
            
            // Ensure percent is a number between 0 and 100
            percent = Math.max(0, Math.min(100, Math.round(parseFloat(percent) || 0)));
            
            // Remove all progress-bar-X classes (keep other classes like progress-bar, progress-bar-striped, etc.)
            const baseClasses = ['progress-bar', 'progress-bar-striped', 'progress-bar-animated', 'bg-success', 'bg-danger'];
            const currentClasses = progressBar.className.split(' ').filter(c => c.trim());
            const filteredClasses = currentClasses.filter(cls => {
                return baseClasses.includes(cls) || !cls.match(/^progress-bar-\d+$/);
            });
            progressBar.className = filteredClasses.join(' ');
            
            // Round to nearest 5% for class-based updates
            const roundedPercent = Math.round(percent / 5) * 5;
            
            // Add the appropriate class
            if (roundedPercent <= 100) {
                progressBar.classList.add('progress-bar-' + roundedPercent);
            } else {
                progressBar.classList.add('progress-bar-100');
            }
            
            // Update aria and text
            progressBar.setAttribute('aria-valuenow', percent);
            progressText.textContent = percent + '%';            
        }
        
        document.getElementById('import-form').addEventListener('submit', function(e) {
            const jsonFile = document.querySelector('input[type="file"][name="json_file"]');
            if (jsonFile && jsonFile.files.length > 0) {
                // Prevent default form submission for JSON imports
                e.preventDefault();
                
                // Show progress bar immediately
                const progressDiv = document.getElementById('import-progress');
                progressDiv.classList.add('show');
                document.getElementById('submit-btn').disabled = true;
                updateProgressBar(0);
                document.getElementById('progress-message').textContent = 'Initializing import...';
                
                // Create FormData and submit via AJAX
                const formData = new FormData(this);
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (response.headers.get('content-type') && response.headers.get('content-type').includes('application/json')) {
                        return response.json();
                    }
                    // If not JSON, it might be a redirect or HTML error
                    if (response.redirected) {
                        window.location.href = response.url;
                        return null;
                    }
                    return response.text();
                })
                .then(data => {
                    if (data && typeof data === 'object' && data.progress_id) {
                        // Start polling with the progress_id from response
                        startProgressPolling(data.progress_id, data.redirect_url);
                    } else if (data && typeof data === 'string') {
                        // Got HTML back - form had errors, reload page to show them
                        document.body.innerHTML = data;
                    } else {
                        // Try to get progress_id from session - start polling immediately
                        // The import is running in the background, so we need to poll for progress_id
                        let attempts = 0;
                        const maxAttempts = 20;
                        const checkProgressId = setInterval(function() {
                            attempts++;
                            fetch('{% url "event_tracker:import_progress" %}?get_id=true')
                                .then(response => response.json())
                                .then(sessionData => {
                                    if (sessionData.progress_id) {
                                        clearInterval(checkProgressId);
                                        startProgressPolling(sessionData.progress_id);
                                    } else if (attempts >= maxAttempts) {
                                        clearInterval(checkProgressId);
                                        document.getElementById('progress-message').textContent = 'Could not get progress ID. Import may still be running...';
                                    }
                                })
                                .catch(err => {
                                    // Silently handle errors during session check
                                });
                        }, 500); // Check every 500ms for progress_id
                    }
                })
                .catch(error => {
                    console.error('Error submitting form:', error);
                    document.getElementById('progress-message').textContent = 'Error submitting import request';
                });
                
                function startProgressPolling(progressId, redirectUrl) {
                    let pollCount = 0;
                    let errorCount = 0;
                    let pollInterval = setInterval(function() {
                        pollCount++;
                        
                        fetch('{% url "event_tracker:import_progress" %}?progress_id=' + progressId)
                            .then(response => {
                                // Check if response is actually JSON
                                const contentType = response.headers.get('content-type');
                                if (!contentType || !contentType.includes('application/json')) {
                                    // Got HTML instead of JSON - likely an error page
                                    return response.text().then(text => {
                                        console.error('Received HTML instead of JSON (poll #' + pollCount + '):', text.substring(0, 200));
                                        throw new Error('Server returned HTML instead of JSON. Status: ' + response.status);
                                    });
                                }
                                
                                if (!response.ok) {
                                    throw new Error('HTTP error! status: ' + response.status);
                                }
                                return response.json();
                            })
                            .then(data => {
                                // Reset error count on successful response
                                errorCount = 0;
                                
                                if (data.status === 'completed' || data.status === 'error') {
                                    clearInterval(pollInterval);
                                    const progressBar = document.getElementById('progress-bar');
                                    progressBar.classList.remove('progress-bar-animated');
                                    
                                    if (data.status === 'completed') {
                                        progressBar.classList.add('bg-success', 'progress-bar-100');
                                        updateProgressBar(100);
                                        document.getElementById('progress-message').textContent = data.message || 'Import completed!';
                                        // Redirect after a short delay
                                        setTimeout(function() {
                                            window.location.href = data.redirect_url || redirectUrl || '{% url "event_tracker:select_operation" %}';
                                        }, 2000);
                                    } else {
                                        progressBar.classList.add('bg-danger');
                                        document.getElementById('progress-message').textContent = data.message || 'Import failed';
                                    }
                                } else if (data.status === 'running' || data.status === 'starting' || data.status === 'not_found') {
                                    const progress = parseInt(data.progress) || 0;
                                    
                                    // Update progress bar using helper function
                                    updateProgressBar(progress);
                                    
                                    if (data.message) {
                                        document.getElementById('progress-message').textContent = data.message;
                                    }
                                    
                                    // If status is 'not_found', it might be starting - keep polling
                                    if (data.status === 'not_found' && pollCount > 30) {
                                        console.warn('Progress not found after 30 seconds, stopping poll');
                                        clearInterval(pollInterval);
                                        document.getElementById('progress-message').textContent = 'Import may have completed or failed. Please check the operations list.';
                                    }
                                } else {
                                    console.warn('Unknown status:', data.status, data);
                                }
                            })
                            .catch(error => {
                                errorCount++;
                                console.error('Error fetching progress (poll #' + pollCount + ', error #' + errorCount + '):', error);
                                
                                // Stop polling after 5 consecutive errors
                                if (errorCount >= 5) {
                                    console.error('Too many consecutive errors (' + errorCount + '), stopping poll');
                                    clearInterval(pollInterval);
                                    const progressBar = document.getElementById('progress-bar');
                                    progressBar.classList.remove('progress-bar-animated');
                                    progressBar.classList.add('bg-danger');
                                    document.getElementById('progress-message').textContent = 'Error communicating with server. Import may still be running. Please check the operations list.';
                                }
                                
                                // Also stop after 60 total errors
                                if (pollCount > 60) {
                                    console.error('Too many total errors, stopping poll');
                                    clearInterval(pollInterval);
                                }
                            });
                        
                        // Stop polling after 10 minutes
                        if (pollCount > 600) {
                            clearInterval(pollInterval);
                            console.warn('Polling stopped after 10 minutes');
                        }
                    }, 1000); // Poll every second
                }
            }
        });
    </script>
</div>
{% endblock body %} 